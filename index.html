<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Notes</title>
  <meta name="author" content="Shichao Yuan">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="Notes"/>

  
    <meta property="og:image" content="undefined"/>
  

  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  



</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">Notes</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class="fa fa-folder"></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 <div class="page-header">
  <h1>Notes</h1>
</div>

<div class="row page">

	
	<div class="col-md-9">
	

		<div class="slogan">
      <i class="fa fa-heart"></i>
      Stay Hungry, Stay Foolish.
</div>    

		<div class="mypage">
		
		<!-- title and entry -->
		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2015-06-15 </div>
			<div class="article-title"><a href="/2015/06/15/link_prediction_problem/" >Link Prediction Problem</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <h2 id="section">1</h2>
<p>最近在看一些好友推荐的东西，所以就多google了一下。</p>
<p>看到一篇论文<a href="http://www.cs.cornell.edu/home/kleinber/link-pred.pdf" target="_blank" rel="external">《The Link Prediction Problem for Social Networks》</a>，感觉写的很不错。</p>
<p>（对这种形式化的描述没抵抗力 :-D）</p>
<p>所以就是做个笔记吧。</p>
<h2 id="section-1">2</h2>
<p>首先<em>social networks</em>可以理解为图，其中<em>nodes</em>表示人或者其他实体，<em>edges</em>标示交互、协作或者关系。</p>
<p>那么好友推荐的问题就可以理解为基于原有的好友关系图结构，预测可能出现的新的关系。</p>
<p>更一般的，可以理解为<em>link prediction problem</em>，基于原有的图结构，预测图的演化。</p>
<blockquote>
<p>the <em>link prediction problem</em>：</p>
<p>Given a snapshot of a social network at time <em>t</em>, we seek to accurately predict the edges that will be added to the network during the interval from time <span class="math inline">\(t\)</span> to a given future time <span class="math inline">\(t&#39;\)</span>.</p>
</blockquote>
<p>当然现实中的交互和关系有很多原因，单单从图结构中是分析不出来的。</p>
<p>但是</p>
<blockquote>
<p>We find that a number of proximity measures lead to predictions that outperform chance by factors of 40 to 50, indicating that the network topology does indeed contain latent information from which to infer future interactions.</p>
</blockquote>
<p>（是这样么？ 暂且相信一下吧，不然就没法继续读下去了 :-D）</p>
<h2 id="section-2">3</h2>
<p>形式化这个问题。</p>
<p>social network: <span class="math inline">\(G = \langle V, E \rangle\)</span></p>
<p>each edge: <span class="math inline">\(e = \langle u, v \rangle \in E\)</span></p>
<p>表示<span class="math inline">\(u,v\)</span>在特定时间<span class="math inline">\(t(e)\)</span>发生交互，其中多次交互记录为并行的边。</p>
<p><span class="math inline">\(G[t, t&#39;]\)</span>表示某时间段内<span class="math inline">\((t &lt; t&#39;)\)</span>的子图。</p>
<p>另外这篇文章为了评估不同的算法还是定义训练和测试的方法：</p>
<blockquote>
<p>We choose four times <span class="math inline">\(t_0 &lt; t&#39;_0 &lt; t_1 &lt; t&#39;_1\)</span>, and give an algorithm access to the network <span class="math inline">\(G[t_0,t&#39;_0]\)</span>; it must then output a list of edges, not present in <span class="math inline">\(G[t_0,t&#39;_0]\)</span>, that are predicted to appear in the network <span class="math inline">\(G[t_1,t&#39;_1]\)</span>. We refer to <span class="math inline">\([t_0,t&#39;_0]\)</span> as the <em>training interval</em> and <span class="math inline">\([t_1,t&#39;_1]\)</span> as the <em>test interval</em>.</p>
<p>Thus, in evaluating link prediction methods, we will generally use two parameters <span class="math inline">\(\mit{κ_{training}}\)</span> and <span class="math inline">\(\mit{κ_{test}}\)</span> (each set to 3 below), and define the set <strong>Core</strong> to be all nodes incident to at least <span class="math inline">\(\mit{κ_{training}}\)</span> edges in <span class="math inline">\(G[t_0, t&#39;_0]\)</span> and at least <span class="math inline">\(\mit{κ_{test}}\)</span> edges in <span class="math inline">\(G[t_1,t&#39;_1]\)</span>. We will then evaluate how accurately the new edges between elements of <strong>Core</strong> can be predicted.</p>
<p>We define the training interval to be the three years <span class="math inline">\([1994, 1996]\)</span>, and the test interval to be <span class="math inline">\([1997, 1999]\)</span>. We denote the subgraph <span class="math inline">\(G[1994, 1996]\)</span> on the training interval by $G_{collab} := A, E_{old} $, and use <span class="math inline">\(E_{new}\)</span> to denote the set of edges <span class="math inline">\(\langle u, v \rangle\)</span> such that <span class="math inline">\(u, v \in A\)</span>, and <span class="math inline">\(u, v\)</span> co-author a paper during the test interval but not the training interval – these are the new interactions we are seeking to predict.</p>
</blockquote>
<p>评估的方法如下：</p>
<blockquote>
<p>Each link predictor <span class="math inline">\(p\)</span> that we consider outputs a ranked list <span class="math inline">\(L_p\)</span> of pairs in <span class="math inline">\(A×A−E_{old}\)</span>; these are predicted new collaborations, in decreasing order of confidence. For our evaluation, we focus on the set <strong>Core</strong>, so we define <span class="math inline">\(E^∗_{new} := E_{new} \cap (Core \times Core)\)</span> and <span class="math inline">\(n := |E^∗_{new}|\)</span>. Our performance measure for predictor <span class="math inline">\(p\)</span> is then determined as follows: from the ranked list <span class="math inline">\(L_p\)</span>, we take the first <span class="math inline">\(n\)</span> pairs in <span class="math inline">\(Core \times Core\)</span>, and determine the size of the intersection of this set of pairs with the set <span class="math inline">\(E^∗_{new}\)</span>.</p>
</blockquote>
<h2 id="section-3">4</h2>
<p>定义方法的输入输出。</p>
<p>输入：<span class="math inline">\(G_{collab}\)</span></p>
<p>输出：<span class="math inline">\(score(x, y)\)</span>降序的列表</p>
<p>基本上可以理解为通过原有的图结构计算节点<span class="math inline">\(x,y\)</span>之间的proximity。</p>
<p>最基本的方法就是计算<span class="math inline">\(G_{collab}\)</span>中<span class="math inline">\(x, y\)</span>的最短路径，为了保持结果降序排列，对路径长度取负值，其中等于1的路径属于训练图。</p>
<h2 id="section-4">5</h2>
<p>Methods based on node neighborhoods</p>
<p><span class="math inline">\(\Gamma(x)\)</span>表示图<span class="math inline">\(G_{collab}\)</span>中节点<span class="math inline">\(x\)</span>的邻居的集合。</p>
<p>直觉上来说，相同的邻居更多的连个节点更容易产生关系，这类方法就是基于这个假设。</p>
<h3 id="common-neighbors">Common neighbors</h3>
<p>$score(x, y) := (x)(y)$</p>
<h3 id="jaccards-coefficient-and-adamicadar">Jaccard’s coefficient and Adamic/Adar</h3>
<p>Jaccard’s coefficient通常用于信息检索中的相似度测量，</p>
<p><span class="math inline">\(score(x, y) := \mid\Gamma(x)\cap\Gamma(y)\mid/\mid\Gamma(x)\cup\Gamma(y)\mid\)</span></p>
<p>Adamic/Adar加大了稀有特征的权重，</p>
<p><span class="math inline">\(score(x,y) := \sum\nolimits_{z\in\Gamma(x)\cap\Gamma(y)}\frac{1}{\log\mid\Gamma(z)\mid}\)</span></p>
<h3 id="preferential-attachment">Preferential attachment</h3>
<p>该方法的基本的假设是节点涉及新边的概率与其邻居的数量成正比，</p>
<p><span class="math inline">\(score(x,y) := \mid\Gamma(x)\mid\cdot\mid\Gamma(y)\mid\)</span></p>
<h2 id="section-5">6</h2>
<p>Methods based on the ensemble of all paths</p>
<p>这类方法基于最短路径的思路，不过是考虑了两点之间所有路径。</p>
<h3 id="katz">Katz</h3>
<p><span class="math inline">\(score(x,y) := \sum\limits_{l=1}^{\infty}\beta^l\cdot\mid paths_{x,y}^{\langle l \rangle} \mid\)</span></p>
<p><span class="math inline">\(paths_{x,y}^{\langle l \rangle} := \{paths\ of\ length\ exactly\ l\ from\ x\ to\ y\}\)</span></p>
<p>当<span class="math inline">\(\beta\)</span>值比较小的时候，结果基本与common neighbors方法类似。</p>
<p>此外该方法还分为加权、不加权两种：</p>
<p>weighted: <span class="math inline">\(paths_{x,y}^{\langle 1 \rangle} := number\ of\ collaborations\ between\ x,y.\)</span></p>
<p>unweighted: <span class="math inline">\(paths_{x,y}^{\langle 1 \rangle} := 1\ iff\ x\ and\ y\ collaborate.\)</span></p>
<h3 id="hitting-times-pagerank-and-variants">Hitting times, PageRank, and variants</h3>
<p>该方法的思想是在<span class="math inline">\(G_{collab}\)</span>上进行<em>random walk</em></p>
<p><em>hitting time</em> <span class="math inline">\(H_{x,y}\)</span>标示从<span class="math inline">\(x\)</span>到<span class="math inline">\(y\)</span>的期望的步数</p>
<p><em>commute time</em> <span class="math inline">\(C_{x,y} := H_{x,y} + H_{y,x}\)</span></p>
<p>但是当<span class="math inline">\(y\)</span>的<em>stationary probability</em> <span class="math inline">\(\pi_y\)</span>比较大的时候，对于任意<span class="math inline">\(x\)</span>，<span class="math inline">\(H_{x,y}\)</span>的值都很小，所以做一点儿归一化。</p>
<p><span class="math inline">\(score(x,y) := -H_{x,y}\cdot\pi_y\)</span></p>
<p><span class="math inline">\(score(x,y) := -(H_{x,y}\cdot\pi_y + H_{y,x}\cdot\pi_x)\)</span></p>
<p>但是这种测量方法还有一个问题，其测量值对图部分的结构更敏感，所以在<em>random walk</em>中加入固定的概率<span class="math inline">\(\alpha\)</span>退回。</p>
<blockquote>
<p>rooted PageRank</p>
<p>stationary distribution weight of <span class="math inline">\(y\)</span> under the following random walk:</p>
<p>with probability <span class="math inline">\(\alpha\)</span>, jump to <span class="math inline">\(x\)</span>.</p>
<p>with probability <span class="math inline">\(1-\alpha\)</span>, go to random neighbor of current node.</p>
</blockquote>
<h3 id="simrank">SimRank</h3>
<p><span class="math inline">\(score(x,y) := \begin{equation}\left \{\begin{array}\\\gamma\cdot\frac{\sum\nolimits_{a\in\Gamma(x)}\sum\nolimits_{b\in\Gamma(y)}score(a,b)}{\mid\Gamma(x)\mid\cdot\mid\Gamma(y)\mid} &amp; otherwise \\1 &amp; if\ x = y\end{array}\right.\end{equation}\)</span></p>
<p><span class="math inline">\(\gamma\in[0,1]\)</span></p>
<blockquote>
<p>SimRank can also be interpreted in terms of a random walk on the collaboration graph: it is the expected value of <span class="math inline">\(\gamma^l\)</span>, where <span class="math inline">\(l\)</span> is a random variable giving the time at which random walks started from <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> first meet.</p>
</blockquote>
<h2 id="section-6">7</h2>
<p>Higher-level approaches</p>
<p>三个meta-approaches，可以结合任一上述方法。</p>
<h3 id="low-rank-approximation">Low-rank approximation</h3>
<p>上述算法都可以转换为矩阵运算，那么就可以用SVD降秩，这也可以看做为一种noise-reduction的方法。</p>
<h3 id="unseen-bigrams">Unseen bigrams</h3>
<blockquote>
<p>Link prediction is akin to the problem of estimating frequencies for unseen bigrams in language modeling—pairs of words that co-occur in a test corpus, but not in the corresponding training corpus.</p>
<p>we can augment our estimates for <span class="math inline">\(score(x, y)\)</span> using values of <span class="math inline">\(score(z, y)\)</span> for nodes <span class="math inline">\(z\)</span> that are “similar” to <span class="math inline">\(x\)</span>.</p>
</blockquote>
<p><span class="math inline">\(score_{unweighted}^*(x,y) := \mid\{z:z\in\Gamma(y)\cap S_x^{\langle\delta\rangle}\}\mid\)</span></p>
<p><span class="math inline">\(score_{weighted}^*(x,y) := \sum\nolimits_{z\in\Gamma(y)\cap S_x^{\langle\delta\rangle}}score(x,z)\)</span></p>
<p><span class="math inline">\(S_x^{\langle\delta\rangle}\)</span>表示基于<span class="math inline">\(score(x,\cdot)\)</span>与<span class="math inline">\(x\)</span>最相关的<span class="math inline">\(\delta\)</span>个节点。</p>
<h3 id="clustering">Clustering</h3>
<p>通过聚类删除一些tenuous的边，然后在cleaned-up的子图上进行计算。</p>
<h2 id="section-7">8</h2>
<p>一些结论</p>
<blockquote>
<p>the small world problem is really a problem. The shortest path between two scientists in wholly unrelated disciplines is often very short (and very tenuous).</p>
<p>Overall, the basic graph distance predictor is not competitive with most of the other approaches studied; our most successful link predictors can be viewed as using measures of proximity that are robust to the few edges that result from rare collaborations between fields.</p>
</blockquote>
<p>AA还是不错的。</p>
<blockquote>
<p>The small world problem suggests that there are many pairs with graph distance two that will not collaborate, but we also observe the dual problem: many pairs that collaborate are at distance larger than two.</p>
</blockquote>

	
	</div>
	
  
</div>
	<a type="button" href="/2015/06/15/link_prediction_problem/#more" class="btn btn-default more">阅读此文</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2015-05-26 </div>
			<div class="article-title"><a href="/2015/05/26/geonear/" >关于附近的XXX</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <h1 id="section">1</h1>
<p>近来的一个需求——附近的XXX。</p>
<p>google一下，</p>
<p>最方便的解决方案是MongoDB的<a href="http://docs.mongodb.org/manual/reference/command/geoNear/" target="_blank" rel="external">geoNear</a>命令。</p>
<p>无奈我司的DBA属于老成持重型的，所以只能使用MySQL……</p>
<p>怎么办呢？</p>
<h1 id="section-1">2</h1>
<p>假设表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+<span class="comment">-------------+------------+------+-----+---------+-------+</span></span><br><span class="line">| Field       | Type       | Null | Key | Default | Extra |</span><br><span class="line">+<span class="comment">-------------+------------+------+-----+---------+-------+</span></span><br><span class="line">| xxx_id      | bigint(20) | NO   | PRI | NULL    |       |</span><br><span class="line">| lat         | double     | NO   |     | NULL    |       |</span><br><span class="line">| lon         | double     | NO   |     | NULL    |       |</span><br><span class="line">+<span class="comment">-------------+------------+------+-----+---------+-------+</span></span><br></pre></td></tr></table></figure>
<p>想找某半径范围内，按照距离远近排序的xxx_id列表，如何写SQL语句呢?</p>
<p>其实我也不会写…… （笑）</p>
<p>不过找到了一个相关的PPT <a href="http://www.notaires.fr/sites/default/files/geo_searchjkkjkj_0.pdf" target="_blank" rel="external">Geo (proximity) Search with MySQL</a></p>
<p>其中给出了SQL语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">set</span> @orig_lat=<span class="number">121.9763</span>;</span> <span class="operator"><span class="keyword">set</span> @orig_lon=<span class="number">37.40445</span>;</span></span><br><span class="line"><span class="operator"><span class="keyword">set</span> @dist=<span class="number">10</span>;</span></span><br><span class="line"><span class="operator"><span class="keyword">SELECT</span> *, <span class="number">3956</span> * <span class="number">2</span> * <span class="keyword">ASIN</span>(<span class="keyword">SQRT</span>(</span><br><span class="line"><span class="keyword">POWER</span>(<span class="keyword">SIN</span>((@orig_lat - <span class="keyword">abs</span>(dest.lat)) * <span class="keyword">pi</span>()/<span class="number">180</span> / <span class="number">2</span>),</span><br><span class="line"><span class="number">2</span>) + <span class="keyword">COS</span>(@orig_lat * <span class="keyword">pi</span>()/<span class="number">180</span> ) * <span class="keyword">COS</span>(<span class="keyword">abs</span>(dest.lat) *</span><br><span class="line"><span class="keyword">pi</span>()/<span class="number">180</span>) * <span class="keyword">POWER</span>(<span class="keyword">SIN</span>((@orig_lon - dest.lon) *</span><br><span class="line"><span class="keyword">pi</span>()/<span class="number">180</span> / <span class="number">2</span>), <span class="number">2</span>) )) <span class="keyword">as</span> distance</span><br><span class="line"><span class="keyword">FROM</span> hotels dest</span><br><span class="line"><span class="keyword">having</span> distance &lt; @dist</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> distance <span class="keyword">limit</span> <span class="number">10</span>\G</span></span><br></pre></td></tr></table></figure>
<p>这么复杂…… 数据量大的话肯定性能低下。</p>
<p>其中给出了一个解决方案，就是通过计算距离缩小探索空间：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#176; of latitude ~= 69 miles&#10;1&#176; of longitude ~= cos(latitude)*69&#10;To calculate lon and lat for the rectangle:</span><br></pre></td></tr></table></figure>
<p>当然这个PPT是某个DBA写的……</p>
<p>我们通常不会把这么多计算的逻辑放在mysql上。</p>
<h1 id="section-2">3</h1>
<p>沿着上述缩小探索范围的思路，就很容易想到一个叫做<a href="http://en.wikipedia.org/wiki/Geohash" target="_blank" rel="external">Geohash</a>的算法。</p>
<p>该算法简而言之就是将地图一半一半地切分成一个个小区域，每个小区域计算出一个一维的编码。</p>
<p>Github上有个很不错的项目——<a href="https://github.com/kungfoo/geohash-java" target="_blank" rel="external">geohash-java</a>——可以直接拿来用。</p>
<p>计算Geohash的核心算法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">GeoHash</span><span class="params">(<span class="keyword">double</span> latitude, <span class="keyword">double</span> longitude, <span class="keyword">int</span> desiredPrecision)</span> </span>&#123;</span><br><span class="line">	point = <span class="keyword">new</span> WGS84Point(latitude, longitude);</span><br><span class="line">	desiredPrecision = Math.min(desiredPrecision, <span class="number">64</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">boolean</span> isEvenBit = <span class="keyword">true</span>;</span><br><span class="line">	<span class="keyword">double</span>[] latitudeRange = &#123; -<span class="number">90</span>, <span class="number">90</span> &#125;;</span><br><span class="line">	<span class="keyword">double</span>[] longitudeRange = &#123; -<span class="number">180</span>, <span class="number">180</span> &#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (significantBits &lt; desiredPrecision) &#123;</span><br><span class="line">		<span class="keyword">if</span> (isEvenBit) &#123;</span><br><span class="line">			divideRangeEncode(longitude, longitudeRange);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			divideRangeEncode(latitude, latitudeRange);</span><br><span class="line">		&#125;</span><br><span class="line">		isEvenBit = !isEvenBit;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	setBoundingBox(<span class="keyword">this</span>, latitudeRange, longitudeRange);</span><br><span class="line">	bits &lt;&lt;= (<span class="number">64</span> - desiredPrecision);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">divideRangeEncode</span><span class="params">(<span class="keyword">double</span> value, <span class="keyword">double</span>[] range)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">double</span> mid = (range[<span class="number">0</span>] + range[<span class="number">1</span>]) / <span class="number">2</span>;</span><br><span class="line">	<span class="keyword">if</span> (value &gt;= mid) &#123;</span><br><span class="line">		addOnBitToEnd();</span><br><span class="line">		range[<span class="number">0</span>] = mid;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		addOffBitToEnd();</span><br><span class="line">		range[<span class="number">1</span>] = mid;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以就在表中多个一个字段：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+<span class="comment">-------------+------------+------+-----+---------+-------+</span></span><br><span class="line">| geo_hash_32 | bigint(20) | NO   | MUL | NULL    |       |</span><br><span class="line">+<span class="comment">-------------+------------+------+-----+---------+-------+</span></span><br></pre></td></tr></table></figure>
<p>32表示geohash的bit长度，也就是维度之间大约300米的范围。</p>
<p>另外这还有个好处，如果数据量上来了还可以通过geo_hash_32字段散表。</p>
<h1 id="section-3">4</h1>
<p>最后串一下整个流程：</p>
<p>某用户在A点，半径m米，</p>
<p>首先计算出覆盖这个半径的geo_hash_32列表，</p>
<p>然后从数据库中查询出数据，</p>
<p>最后计算距离、排序</p>
<h1 id="section-4">5</h1>
<p>记得之前看过一篇介绍uber架构的文章——<a href="http://www.infoq.com/news/2015/03/uber-realtime-market-platform" target="_blank" rel="external">Uber Unveils its Realtime Market Platform</a>，</p>
<p>其中提到了一个称为<a href="https://code.google.com/p/s2-geometry-library/" target="_blank" rel="external">s2-geometry-library</a>的类库。</p>
<blockquote>
<p>The S2 Geometry Library is a spherical geometry library, very useful for manipulating regions on the sphere (commonly on Earth) and indexing geographic data.</p>
</blockquote>
<p>具体细节、暂且留坑。</p>

	
	</div>
	
  
</div>
	<a type="button" href="/2015/05/26/geonear/#more" class="btn btn-default more">阅读此文</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2015-04-09 </div>
			<div class="article-title"><a href="/2015/04/09/privoxy/" >小工具Privoxy</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <h1 id="section">1</h1>
<p>抓取墙外的内容，</p>
<p>翻墙，</p>
<p>VPN，在程序中调用不方便；代理，比较方便。</p>
<p>有一台墙外的服务器，安装了<a href="https://github.com/shadowsocks/shadowsocks" target="_blank" rel="external">shadowsocks</a></p>
<p>shadowsocks走的是socks5协议，</p>
<p>在程序中调用也不太方便，虽然shadowsocks是用python写的，但是在python3中使用socks5代理真是不方便……</p>
<p>如果能转成HTTP(s)协议就好了~</p>
<h1 id="section-1">2</h1>
<p>怎么办？</p>
<p>有个小工具<a href="http://www.privoxy.org/" target="_blank" rel="external">Privoxy</a></p>
<p>实际上这个工具相对强大，这里只使用了几个简单的功能。</p>
<blockquote>
<p>Privoxy is a non-caching web proxy with advanced filtering capabilities for enhancing privacy, modifying web page data and HTTP headers, controlling access, and removing ads and other obnoxious Internet junk. Privoxy has a flexible configuration and can be customized to suit individual needs and tastes. It has application for both stand-alone systems and multi-user networks.</p>
</blockquote>
<p>编译安装，参考<a href="http://www.privoxy.org/user-manual/installation.html#INSTALLATION-SOURCE" target="_blank" rel="external">2.2. Building from Source</a></p>
<p>配置文件默认位于<code>/usr/local/etc/privoxy</code></p>
<h1 id="section-2">3</h1>
<p>将socks5协议转成HTTP(s)协议</p>
<p>修改<code>config</code>，添加如下规则</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">forward-socks5 / xx.xx.xx.xx:1080 .</span><br></pre></td></tr></table></figure>
<p>为了让外网用户也能访问该服务，修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\#listen-address  127.0.0.1:8118&#10;listen-address  0.0.0.0:8118</span><br></pre></td></tr></table></figure>
<h1 id="section-3">4</h1>
<p>另外需要限制一下可以访问的域名</p>
<p>在添加两个配置文件<code>blacklist.action</code>和<code>whitelist.action</code></p>
<p>内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># blacklist.action&#10;&#123; +block &#125;&#10;/</span><br></pre></td></tr></table></figure>
<p>加过滤，也就是过滤所有域名。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># whitelist.action&#10;&#123; -block &#125;&#10;instagram.com</span><br></pre></td></tr></table></figure>
<p>减过滤，也就是允许访问<code>instagram.com</code></p>
<p>在<code>config</code>添加两行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">actionsfile blacklist.action&#10;actionsfile whitelist.action</span><br></pre></td></tr></table></figure>

	
	</div>
	
  
</div>
	<a type="button" href="/2015/04/09/privoxy/#more" class="btn btn-default more">阅读此文</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2015-03-21 </div>
			<div class="article-title"><a href="/2015/03/21/popular_data/" >思考热门发现Tab的内容配置</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <h1 id="section">1</h1>
<p>之前有篇文章是介绍<a href="http://shichaoyuan.github.io/engineering/2015/02/12/copy_ins_popular_tab.html">如何山寨Instagram的热门发现Tab</a></p>
<p>其中留了一个坑，如何配置不同类型的数据。</p>
<p>近来跟PM讨论的比较多，所以记一下。</p>
<h1 id="section-1">2</h1>
<p>首先交代一下背景，</p>
<p>小项目、刚起步，</p>
<p>没有什么数据，直接通过data mining的方法不太合适，</p>
<p>所以运营人员会维护一个热门内容库，并且会对热门内容打tag，包括feed和user。</p>
<p>然后是对于发现页的定位，</p>
<p>帮助用户发现自己感兴趣的东西，引导用户关注这些内容。</p>
<h1 id="section-2">3</h1>
<h2 id="第一个想法-直接random">第一个想法 —— 直接Random</h2>
<p>直接对热门内容库随机选择，这个想法最直观，</p>
<p>而且毕竟是经过运营人员筛选出来的，质量通常相当的高。</p>
<p>简单、直接。</p>
<h2 id="第二个想法-以时间做为权重random">第二个想法 —— 以时间做为权重Random</h2>
<p>这是一个很直观的优化，新feed感觉上应该更容易引起支持，特别是某些热门一时的话题。</p>
<p>可以简单这样来算：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">double</span> <span class="title">calculateWeightByTime</span><span class="params">(Date date)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">double</span> weight = <span class="number">1.0</span>;</span><br><span class="line">    <span class="keyword">double</span> deltaDay = ((<span class="keyword">double</span>)(System.currentTimeMillis() - date.getTime())) / <span class="number">1000.0</span> / <span class="number">60.0</span> / <span class="number">60.0</span> / <span class="number">24.0</span>;</span><br><span class="line">    <span class="keyword">if</span> (deltaDay &lt; <span class="number">99.0</span>) &#123;</span><br><span class="line">        weight = <span class="number">100</span> - deltaDay;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> weight;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>目前线上的算法就是这个，按照友盟的统计，在热门发现页40%左右的点击会进入feed终端页。</p>
<h1 id="section-3">4</h1>
<h2 id="第三个想法">第三个想法</h2>
<h3 id="问题">问题：</h3>
<p>用户（我们）到底想看到什么内容？</p>
<p>感兴趣的呗。</p>
<p>什么是感兴趣的？</p>
<p>给用户一个列表，让其选择。</p>
<p>根据我们使用app的经历，这个方式比较不靠谱。</p>
<p>为什么？</p>
<p>因为很多时候并不知道自己喜欢什么，所以通常都是随便选几个。</p>
<p>那么现在的问题就是如何获取用户的兴趣。</p>
<h3 id="判断用户的兴趣">判断用户的兴趣</h3>
<p>因为目前有运营的支持，对于优质用户会对其打tag，那么我们可以这样理解用户的兴趣。</p>
<p>用户A关注了用户B，那么用户A的兴趣可以理解为用户B的tags。</p>
<p>这个逻辑总体来说是说的通的，除了礼貌性的互粉，但是身上有tag的用户都是运营筛选出来的，所以这种情况相对不会太多。</p>
<p>另外用户的兴趣也是会变化的，所以基于关注行为判断用户当前的兴趣是一个相对可取的方法。</p>
<p>在于数据量比较少，运营顶得住的情况下，这是一个不错的策略。</p>
<p>当然也可以通过用户点赞和评论的行为，判断用户当前的兴趣。</p>
<p>当数据量上来之后，就可以改为通过协同过滤推荐计算用户当前感兴趣的内容。</p>
<h3 id="问题-1">问题</h3>
<p>既然想出了一种判断用户当前兴趣的方法，那么是否狂推这些内容就行了？</p>
<p>看多了也就看厌了，所以还是想看到一些未知的。</p>
<p>那么现在的问题就是怎么配置已经感兴趣的内容与未知的内容。</p>
<h3 id="配置内容">配置内容</h3>
<p>目前有两个来源：</p>
<ol style="list-style-type: decimal">
<li>运营筛选的。这些内容和用户都会被打tag。</li>
<li>算法计算的。目前是协同过滤推荐，目前来说只是为了丰富一下内容源。</li>
</ol>
<p>基于用户的兴趣，运营筛选的内容可以分为动态的分为两类：</p>
<ol style="list-style-type: decimal">
<li>用户目前感兴趣的内容</li>
<li>未知内容</li>
</ol>
<p>那么怎么控制比例呢？</p>
<p>拍脑袋，第一类80%，第二类20%。</p>
<p>然后根据用户的刷新的次数，依次衰减第一类的比例。</p>
<p>大致的思路就是这样。</p>
<h1 id="section-4">5</h1>
<h2 id="怎么实现">怎么实现</h2>
<p>逻辑比较复杂，怎么兼顾响应时间呢？</p>
<p>大致的实现思路如下：</p>
<p>根据用户的兴趣，将运营筛选的内容分为两类，放到redis中，</p>
<p>当有新的关注行为，也就是新的兴趣时，异步更新redis。</p>
<p>用户拉取热门内容时，</p>
<p>拉取redis中的内容，过滤掉已经关注的用户的内容，</p>
<p>根据时间权重随机选择。</p>
<p>如果内容太少，使用协同过滤推荐计算的内容补全。</p>
<p>最后shuffle一下，搞定。</p>

	
	</div>
	
  
</div>
	<a type="button" href="/2015/03/21/popular_data/#more" class="btn btn-default more">阅读此文</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2015-02-16 </div>
			<div class="article-title"><a href="/2015/02/16/gc_log_1/" >关于JAVA GC LOG —— 如何看</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <p>本文基于Java HotSpot(TM) 64-Bit Server VM (build 24.71-b01, mixed mode)</p>
<h1 id="section">1</h1>
<p>GC相关的几个JVM启动参数：</p>
<table>
<thead>
<tr class="header">
<th align="left">参数</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">-XX:+PrintGCDetails</td>
<td align="left">Print more details at garbage collection. Manageable. (Introduced in 1.4.0.)</td>
</tr>
<tr class="even">
<td align="left">-XX:+PrintGCDateStamps</td>
<td align="left">Enables printing of a date stamp at every GC</td>
</tr>
<tr class="odd">
<td align="left">-Xloggc::filename</td>
<td align="left">Log GC verbose output to specified file. The verbose output is controlled by the normal verbose GC flags.</td>
</tr>
<tr class="even">
<td align="left">-XX:+UseGCLogFileRotation</td>
<td align="left">Enabled GC log rotation, requires -Xloggc.</td>
</tr>
<tr class="odd">
<td align="left">-XX:NumberOfGCLogFiles=1</td>
<td align="left">Set the number of files to use when rotating logs, must be &gt;= 1. The rotated log files will use the following naming scheme, filename.0, filename.1, …, filename.n-1.</td>
</tr>
<tr class="even">
<td align="left">-XX:GCLogFileSize=8K</td>
<td align="left">The size of the log file at which point the log will be rotated, must be &gt;= 8K.</td>
</tr>
<tr class="odd">
<td align="left">-XX:+PrintTenuringDistribution</td>
<td align="left">Print tenuring age information.</td>
</tr>
</tbody>
</table>
<p>其它参数，详见<a href="http://www.oracle.com/technetwork/java/javase/tech/vmoptions-jsp-140102.html" target="_blank" rel="external">Java HotSpot VM Options</a></p>
<h1 id="section-1">2</h1>
<p>一个Tomcat/7.0.26的例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#10;JAVA_OPTS=&#34;-server -Xms1500M -Xmx1500M -Xmn500M -Xss256k -XX:PermSize=256m -XX:MaxPermSize=256m -XX:+UseParNewGC -XX:ParallelGCThreads=8 -XX:SurvivorRatio=6 -XX:TargetSurvivorRatio=90 -XX:MaxTenuringThreshold=15 -XX:SoftRefLRUPolicyMSPerMB=0 -XX:+UseConcMarkSweepGC -XX:+CMSIncrementalMode -XX:+UseCMSCompactAtFullCollection -XX:CMSFullGCsBeforeCompaction=5 -XX:CMSInitiatingOccupancyFraction=55 -XX:CMSIncrementalSafetyFactor=20 -XX:+PrintGCDetails -XX:+PrintGCDateStamps -Xloggc:../logs/gc-$DATE.log -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=5 -XX:GCLogFileSize=128K -XX:+PrintTenuringDistribution &#34;</span><br></pre></td></tr></table></figure>
<p>对于young generation，使用ParNew；对于Tenured generation，使用CMS。</p>
<p>如何配置这些不同的算法，详见<a href="https://blogs.oracle.com/jonthecollector/entry/our_collectors" target="_blank" rel="external">Our Collectors</a></p>
<p>一段GC日志：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#10;2015-02-05T19:27:34.537+0800: 3737.811: [Full GC2015-02-05T19:27:34.537+0800: 3737.812: [CMS: 68036K-&#62;71687K(1024000K), 0.3253180 secs] 228627K-&#62;71687K(1472000K), [CMS Perm : 58490K-&#62;58337K(262144K)] icms_dc=0 , 0.3257740 secs] [Times: user=0.33 sys=0.00, real=0.33 secs]&#10;2015-02-05T19:27:34.866+0800: 3738.141: [GC [1 CMS-initial-mark: 71687K(1024000K)] 71689K(1472000K), 0.0041430 secs] [Times: user=0.01 sys=0.00, real=0.01 secs]&#10;2015-02-05T19:27:34.871+0800: 3738.145: [CMS-concurrent-mark-start]&#10;2015-02-05T19:31:25.881+0800: 3969.156: [GC2015-02-05T19:31:25.881+0800: 3969.156: [ParNew&#10;Desired survivor size 58982400 bytes, new threshold 15 (max 15)&#10;- age   1:    8783432 bytes,    8783432 total&#10;: 384000K-&#62;13384K(448000K), 0.0148490 secs] 455687K-&#62;85071K(1472000K) icms_dc=0 , 0.0153590 secs] [Times: user=0.05 sys=0.00, real=0.02 secs]&#10;2015-02-05T19:33:50.170+0800: 4113.445: [GC2015-02-05T19:33:50.171+0800: 4113.445: [ParNew&#10;Desired survivor size 58982400 bytes, new threshold 15 (max 15)&#10;- age   1:    5015016 bytes,    5015016 total&#10;- age   2:    3093632 bytes,    8108648 total</span><br></pre></td></tr></table></figure>
<p>我们仔细看看：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#10;2015-02-05T19:27:34.537+0800:(&#26085;&#26399;) 3737.811:(&#26102;&#38388;&#25139;) [Full GC(&#22403;&#22334;&#25910;&#38598;&#31867;&#22411;)2015-02-05T19:27:34.537+0800:(&#26085;&#26399;) 3737.812:(&#26102;&#38388;&#25139;) [CMS:(&#31639;&#27861;&#20197;&#21450;generation) 68036K-&#62;71687K(1024000K), 0.3253180 secs(Tenured generation&#30340;&#24773;&#20917;)] 228627K-&#62;71687K(1472000K)(&#25972;&#20010;&#22534;&#30340;&#24773;&#20917;), [CMS Perm : 58490K-&#62;58337K(262144K)(Perm&#30340;&#24773;&#20917;)] icms_dc=0 , 0.3257740 secs] [Times: user=0.33 sys=0.00, real=0.33 secs]&#10;&#10;2015-02-05T19:31:25.881+0800: 3969.156: [GC2015-02-05T19:31:25.881+0800: 3969.156: [ParNew&#10;Desired survivor size 58982400 bytes, new threshold 15 (max 15)&#10;- age   1:    8783432 bytes,    8783432 total&#10;: 384000K-&#62;13384K(448000K), 0.0148490 secs] 455687K-&#62;85071K(1472000K) icms_dc=0 , 0.0153590 secs] [Times: user=0.05 sys=0.00, real=0.02 secs]</span><br></pre></td></tr></table></figure>
<p>更加详细的分析，参考<a href="https://blogs.oracle.com/poonam/entry/understanding_cms_gc_logs" target="_blank" rel="external">Understanding CMS GC Logs</a></p>
<h1 id="section-2">3</h1>
<p>如何可视化？</p>
<p>使用<a href="https://github.com/chewiebug/GCViewer" target="_blank" rel="external">GCViewer</a></p>

	
	</div>
	
  
</div>
	<a type="button" href="/2015/02/16/gc_log_1/#more" class="btn btn-default more">阅读此文</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2015-02-12 </div>
			<div class="article-title"><a href="/2015/02/12/copy_ins_popular_tab/" >如何高仿Instagram的热门发现Tab</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <h1 id="section">1</h1>
<p>最近在做的项目类似Instagram，其中第二个Tab基本上完全一致……</p>
<p>如何做呢？</p>
<p>首先看看INS是如何做的。</p>
<p>狂刷INS的第二个Tab，发现其中的feed分了两类：“全球热门项目”和“根据你关注的用户”；点击进入feed终端页，感觉内容你预先加载完的（除了照片）。</p>
<p>申请一个开发者账号，调用一下https://api.instagram.com/v1/media/popular?access_token=ACCESS-TOKEN</p>
<p>发现其返回的json包含feed的完整信息。</p>
<h1 id="section-1">2</h1>
<p>我们的需求：</p>
<ol style="list-style-type: decimal">
<li>下拉刷新，根据权重随机呈现；</li>
<li>上滑翻页，分页读取；</li>
<li>多个内容源，比如：运营筛选、算法推荐、地理位置；</li>
<li>可以很用容易改变不同内容源的配比。</li>
</ol>
<p>还有不要太慢 嘻嘻</p>
<h1 id="section-2">3</h1>
<p>总体设计：</p>
<ol style="list-style-type: decimal">
<li>生产内容源；</li>
<li>配比内容源，更新线上内容库；</li>
<li>读取线上内容库，根据权重随机呈现。</li>
</ol>
<p>其中使用Redis做为线上内容库。</p>
<h1 id="section-3">4</h1>
<p>生产内容源</p>
<p>目前有两个：一个mahout的协同过滤推荐算法，一个运营人员筛选。</p>
<p>没什么需要解释的。</p>
<h1 id="section-4">5</h1>
<p>配比内容源，更新线上内容库；</p>
<p>一个定时任务，从不同的内容源中选择不同的配备的内容，然后推送到Redis中。</p>
<p>其中如何设定权重是一个比较有趣的问题，先留坑。</p>
<h1 id="section-5">6</h1>
<p>读取线上内容库，根据权重随机呈现</p>
<p>Redis中数据的组织形式是，userId对应一个redisList，redisList中数据项的序列化和反序列化使用protobuf。</p>
<p>目前设想单个user对应feed的数量为一万左右，如果一次全部读取，并发量较高的时候，程序GC的负担会比较重，所以使用了分段读取的方法——<a href="https://github.com/shichaoyuan/snippets/blob/master/RedisListIterator.java" target="_blank" rel="external">RedisListIterator.java</a>。</p>
<p>如何根据权重随机选择，参考之前的文章——<a href="http://shichaoyuan.github.io/algorithm/2014/12/28/sample_algorithm.html">关于sample算法</a>。</p>
<p>至于分页，用Reids的List也很容易解决。</p>
<h1 id="section-6">7</h1>
<p>该接口的性能基本上严重依赖Redis的性能；</p>
<p>随着用户的增加，Reids集群的容量也得成正比增加。</p>

	
	</div>
	
  
</div>
	<a type="button" href="/2015/02/12/copy_ins_popular_tab/#more" class="btn btn-default more">阅读此文</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2015-01-29 </div>
			<div class="article-title"><a href="/2015/01/29/logrotate/" >命令logrotate</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <h1 id="section">1</h1>
<p>最近在做的项目中有个小问题：</p>
<p>nginx的log不支持自动分割（类似log4j的<code>DailyRollingFileAppender</code>）。</p>
<p>查了一下，有个小命令logrotate可以很好的解决这个问题。</p>
<h1 id="section-1">2</h1>
<p>logrotate在笔者使用的服务器<code>CentOS release 6.5</code>上已经自带安装了，所以略过安装的部分。</p>
<p>首先，在<code>/etc/logrotate.d/nginx</code>中配置log文件的分割逻辑，</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/home/xxx/nginx/logs/*.log &#123;</span><br><span class="line">    daily</span><br><span class="line">    dateext</span><br><span class="line">    compress</span><br><span class="line">    rotate <span class="number">30</span></span><br><span class="line">    create <span class="number">644</span> xxx xxx</span><br><span class="line">    delaycompress</span><br><span class="line">    notifempty</span><br><span class="line">    sharedscripts</span><br><span class="line">    postrotate</span><br><span class="line">        [ <span class="operator">-f</span> /usr/<span class="built_in">local</span>/nginx/logs/nginx.pid ] &amp;&amp; <span class="built_in">kill</span> -USR1 `cat /usr/<span class="built_in">local</span>/nginx/logs/nginx.pid`</span><br><span class="line">    endscript</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体的参数详见<a href="http://linuxcommand.org/man_pages/logrotate8.html" target="_blank" rel="external">logrotate8.html</a></p>
<p>需要解释一下的是delaycompress和sharedscripts这两个参数。</p>
<blockquote>
<p>delaycompress</p>
</blockquote>
<blockquote>
<p>Postpone compression of the previous log file to the next rotation cycle. This has only effect when used in combination with compress. It can be used when some program can not be told to close its logfile and thus might continue writing to the previous log file for some time.</p>
</blockquote>
<p>简而言之，20号执行命令，那么压缩19号的log文件。 如果马上压缩，那么就会使得分割之后（kill -USR1之前）的部分log丢失，如果隔一天再压缩就没有这个问题。</p>
<blockquote>
<p>sharedscripts</p>
</blockquote>
<blockquote>
<p>Normally, prescript and postscript scripts are run for each log which is rotated, meaning that a single script may be run multiple times for log file entries which match multiple files (such as the /var/log/news/* example). If sharedscript is specified, the scripts are only run once, no matter how many logs match the wildcarded pattern. However, if none of the logs in the pattern require rotating, the scripts will not be run at all. This option overrides the nosharedscripts option and implies create option.</p>
</blockquote>
<p>因为用到了通配符，sharedscripts的作用就是在所有log文件都处理完后再执行下面的脚本，如果没有添加这个参数，那么每处理完一个文件就执行一次脚本。</p>
<h1 id="section-2">3</h1>
<p>好的，配置完了，那么logrotate是怎么执行的呢？</p>
<p>很简单，基于CRON。</p>
<p><code>/etc/logrotate.conf</code>是logrotate的配置文件，前面nginx中配置的参数，会覆盖其中的缺省参数。</p>
<p>接着往上找，<code>/etc/cron.daily/logrotate</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="shebang">#!/bin/sh</span><br><span class="line"></span></span><br><span class="line">/usr/sbin/logrotate /etc/logrotate.conf &gt;/dev/null <span class="number">2</span>&gt;&amp;<span class="number">1</span></span><br><span class="line">EXITVALUE=$?</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$EXITVALUE</span> != <span class="number">0</span> ]; <span class="keyword">then</span></span><br><span class="line">    /usr/bin/logger -t logrotate <span class="string">"ALERT exited abnormally with [<span class="variable">$EXITVALUE</span>]"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">exit</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>这个脚本很简单，就是执行logrotate这个命令。</p>
<p>再接着往上找，<code>/etc/cron.d/0daily</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SHELL=/bin/bash</span><br><span class="line">PATH=/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class="line">MAILTO=root</span><br><span class="line">HOME=/</span><br><span class="line"><span class="number">5</span> <span class="number">1</span> * * * root run-parts /etc/cron.daily</span><br></pre></td></tr></table></figure>
<p>这里指定了<code>cron.daily</code>的执行时间。</p>
<h1 id="section-3">4</h1>
<p>如果不想等，想直接看效果，怎么办？</p>
<p>执行<code>logrotate -f /etc/logrotate.d/nginx</code>。</p>
<p>为什么执行第一次有效果，执行第二次就没有效果了？</p>
<p>因为logrotate会记录执行的状态，默认保存在<code>/var/lib/logrotate.status</code>中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logrotate state -- version 2&#10;&#34;/home/xxx/nginx/logs/error.log&#34; 2015-1-29&#10;&#34;/home/xxx/nginx/logs/access.log&#34; 2015-1-29&#10;&#34;/home/xxx/nginx/logs/*.log&#34; 2015-1-12</span><br></pre></td></tr></table></figure>
<p>如果想再次执行，那么修改一下日期，或者删掉改行就行。</p>
<h1 id="section-4">5</h1>
<p>还有一个比较容易忽略的问题，</p>
<p><code>/etc/logrotate.d/nginx</code>文件的mode建议为<code>644</code>，否则可能无法执行。</p>
<p>具体的原因参见<a href="https://fedorahosted.org/logrotate/changeset/302" target="_blank" rel="external">Changeset 302</a></p>

	
	</div>
	
  
</div>
	<a type="button" href="/2015/01/29/logrotate/#more" class="btn btn-default more">阅读此文</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2014-12-28 </div>
			<div class="article-title"><a href="/2014/12/28/sample_algorithm/" >关于sample算法</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <h1 id="section">1</h1>
<p>最近在做的项目中有个需求，就是从热门内容库中，随机地吐出少量的热门内容。</p>
<p>笔者首先想到的是洗牌算法——<a href="http://en.wikipedia.org/wiki/Fisher%E2%80%93Yates_shuffle" target="_blank" rel="external">Fisher–Yates shuffle</a>。</p>
<p>洗牌算法顾名思义，等洗完牌后，选择前几个或者后几个就行，</p>
<p>因为热门内容笔者设计为不能修改的，所以实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">sampleFisherYates</span><span class="params">(List&lt;T&gt; population, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (population == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> n = population.size();</span><br><span class="line">    <span class="keyword">if</span> (k &lt; <span class="number">0</span> || k &gt; n) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    Random random = <span class="keyword">new</span> Random();</span><br><span class="line">    List&lt;T&gt; result = <span class="keyword">new</span> ArrayList&lt;T&gt;(k);</span><br><span class="line">    List&lt;T&gt; pool = <span class="keyword">new</span> ArrayList&lt;T&gt;(population);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; k; i++) &#123;</span><br><span class="line">        <span class="keyword">int</span> j = random.nextInt(n-i);</span><br><span class="line">        result.add(pool.get(j));</span><br><span class="line">        pool.set(j, pool.get(n-i-<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个实现有个问题，如果population相对于k比较大，List的拷贝就会成为性能的瓶颈，而且还有OOM的隐患。</p>
<p>如何解决？设定一个阈值，如果<code>population.size()/k</code>小于某个阈值，就是使用上述方法；如果大于某个阈值，那么想其他办法。</p>
<p>如何设定这个阈值呢？笔者此时想起了python中有个<code>random.sample</code>方法，所以就参考一下吧——<a href="https://hg.python.org/cpython/file/32c5b9aeee82/Lib/random.py" target="_blank" rel="external">Lib/random.py</a>。</p>
<p>笔者简单地将python代码转成了java代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">samplePython</span><span class="params">(List&lt;T&gt; population, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (population == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> n = population.size();</span><br><span class="line">    <span class="keyword">if</span> (k &lt; <span class="number">0</span> || k &gt; n) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    List&lt;T&gt; result = <span class="keyword">new</span> ArrayList&lt;T&gt;(k);</span><br><span class="line">    <span class="keyword">int</span> setsize = <span class="number">21</span>;</span><br><span class="line">    <span class="keyword">if</span> (k &gt; <span class="number">5</span>) &#123;</span><br><span class="line">        setsize += (<span class="keyword">int</span>)Math.pow(<span class="number">4</span>, Math.ceil(Math.log(k*<span class="number">3</span>)/Math.log(<span class="number">4</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">    Random random = <span class="keyword">new</span> Random();</span><br><span class="line">    <span class="keyword">if</span> (n &lt;= setsize) &#123;</span><br><span class="line">        List&lt;T&gt; pool = <span class="keyword">new</span> ArrayList&lt;T&gt;(population);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; k; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> j = random.nextInt(n-i);</span><br><span class="line">            result.add(pool.get(j));</span><br><span class="line">            pool.set(j, pool.get(n-i-<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Set&lt;Integer&gt; selected = <span class="keyword">new</span> HashSet&lt;Integer&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; k; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> j = random.nextInt(n);</span><br><span class="line">            <span class="keyword">while</span>(selected.contains(j)) &#123;</span><br><span class="line">                j = random.nextInt(n);</span><br><span class="line">            &#125;</span><br><span class="line">            selected.add(j);</span><br><span class="line">            result.add(population.get(j));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>基本上就是，阈值以4的指数增加，如果总量大于这个值，那么就随机的选择，如果重复了，再选一个，直到不重复。</p>
<p>这样基本上就满足目前的需求了。</p>
<h1 id="section-1">2</h1>
<p>如果热门内容库本地装不下，需要放到redis中，那么？</p>
<p>（当然这不太可能。。。简单计算一下，拿出1G内存对当前的机器来说是小case，一个热门内容就是几个url和几串文字，顶多500个Byte，那么能装下的热门内容条数也有两百多万。）</p>
<p>但是还是想一下吧，笔者在wikipedia上搜到了<a href="http://en.wikipedia.org/wiki/Reservoir_sampling" target="_blank" rel="external">Reservoir sampling</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">sampleReservoir</span><span class="params">(List&lt;T&gt; population, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (population == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">if</span> (k &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">	    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    List&lt;T&gt; result = <span class="keyword">new</span> ArrayList&lt;T&gt;(k);</span><br><span class="line">    Random random = <span class="keyword">new</span> Random();</span><br><span class="line">    Iterator&lt;T&gt; iter = population.iterator();</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i &lt; k) &#123;</span><br><span class="line">            result.add(iter.next());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> r = random.nextInt(i+<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (r &lt; k) &#123;</span><br><span class="line">                result.set(r, iter.next());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                iter.next();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于线上环境感觉没有太合适的应用场景，如果真的数据量非常大，所有数据拉取遍历一遍，恐怕接口的响应速度就hold不住了。</p>
<p>所以简单地随机选，重复了就重新选就可以，当然前提是得知道redis中数据的总量。</p>
<p>当然对于线下，每天定时执行个hadoop任务，从一个超大集合中随机选择出一个小集合，那么修改一下上述算法还是很合适的。</p>
<p>另外还有选择出的集合在内存中装不下的情况，在此笔者就暂且不深究了。</p>
<h1 id="section-2">3</h1>
<p>还有一个很现实的需求，热门内容应该是可以设置权重的，权重高的被选择的概率大。</p>
<p>这个在wikipedia上没找到，所以google一下，找到了一篇论文<a href="http://arxiv.org/pdf/1012.0256.pdf" target="_blank" rel="external">Weighted Random Sampling over Data Streams</a></p>
<p>其中介绍了A-Chao和A-ES两种算法，这两者的区别主要在于如何使用权重。</p>
<blockquote>
<p>The problem classes WRS-P and WRS-W differ in the way the item weights are used in the sampling procedure. In WRS-P the weights are used to directly determine the final selection probability of each item and this probability is easy to calculate. On the other hand, in WRS-W the item weights are used to determine the selection probability of each item in each step of a supposed sequential sampling procedure. In this case it is easy to study each step of the sampling procedure, but the final selection probabilities of the items seem to be hard to calculate. In the general case, a complex expression has to be evaluated in order to calculate the exact inclusion probability of each item and we are not aware of an efficient procedure to calculate this expression. An interesting feature of random samples generated with WRS-W is that they support the concept of order for the sampled items. The item that is selected first or simply has the largest key (algorithm A-ES) can be assumed to take the first position, the second largest the second position etc. The concept of order can be useful in certain applications. We illustrate the two sampling approaches in the following example.</p>
</blockquote>
<blockquote>
<p>On-line advertisements. A search engine shows with the results of each query a set of k sponsored links that are related to the search query. If there are n sponsored links that are relevant to a query then how should the set of k links be selected? If all sponsors have paid the same amount of money then any uniform sampling algorithm without replacement can solve the problem. If however, every sponsor has a different weight than how should the k items be selected? Assuming that the k positions are equivalent in “impact”, a sponsor who has the double weight with respect to another sponsor may expect its advertisement to appear twice as often in the results. Thus, a reasonable approach would be to use algorithm A-Chao to generate a WRS-N-P of k items. If however, the advertisement slots are ordered based on their impact, for example the first slot may have the largest impact, the second the second largest etc., then algorithm A-ES may provide the appropriate solution by generating a WRS-N-W of k items.</p>
</blockquote>
<p>另外如果数据量非常大，而且对性能比较关心，那么可以结合jumps方法。</p>
<p>论文的作者提供了算法的java代码，笔者也简单实现了一下A-ES算法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WeightedItem</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> T value;</span><br><span class="line">    <span class="keyword">private</span> Double weight;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setValue</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Double <span class="title">getWeight</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> weight;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setWeight</span><span class="params">(Double weight)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.weight = weight;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SampledItem</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Comparable</span>&lt;<span class="title">SampledItem</span>&lt;<span class="title">T</span>&gt;&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> T value;</span><br><span class="line">    <span class="keyword">private</span> Double key;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setValue</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Double <span class="title">getKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> key;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setKey</span><span class="params">(Double key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.key = key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(SampledItem&lt;T&gt; that)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.getKey().compareTo(that.getKey());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; List&lt;SampledItem&lt;T&gt;&gt; sampleAES(List&lt;WeightedItem&lt;T&gt;&gt; population, <span class="keyword">int</span> k) &#123;</span><br><span class="line">    <span class="keyword">if</span> (population == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (k &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    Queue&lt;SampledItem&lt;T&gt;&gt; result = <span class="keyword">new</span> PriorityQueue&lt;SampledItem&lt;T&gt;&gt;(k);</span><br><span class="line">    </span><br><span class="line">    Random random = <span class="keyword">new</span> Random();</span><br><span class="line">    Iterator&lt;WeightedItem&lt;T&gt;&gt; iter = population.iterator();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; k; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (iter.hasNext()) &#123;</span><br><span class="line">            WeightedItem&lt;T&gt; weightedItem = iter.next();</span><br><span class="line">            SampledItem&lt;T&gt; sampledItem = <span class="keyword">new</span> SampledItem&lt;T&gt;();</span><br><span class="line">            sampledItem.setKey(genKey(random, weightedItem.getWeight()));</span><br><span class="line">            sampledItem.setValue(weightedItem.getValue());</span><br><span class="line">            result.add(sampledItem);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">        WeightedItem&lt;T&gt; weightedItem = iter.next();</span><br><span class="line">        <span class="keyword">double</span> key = genKey(random, weightedItem.getWeight());</span><br><span class="line">        SampledItem&lt;T&gt; minItem = result.peek();</span><br><span class="line">        <span class="keyword">if</span> (key &gt; minItem.getKey()) &#123;</span><br><span class="line">            result.poll();</span><br><span class="line">            SampledItem&lt;T&gt; sampledItem = <span class="keyword">new</span> SampledItem&lt;T&gt;();</span><br><span class="line">            sampledItem.setKey(key);</span><br><span class="line">            sampledItem.setValue(weightedItem.getValue());</span><br><span class="line">            result.add(sampledItem);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ArrayList&lt;SampledItem&lt;T&gt;&gt;(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="https://github.com/shichaoyuan/snippets/blob/master/SampleUtil.java" target="_blank" rel="external">SampleUtil.java</a></p>

	
	</div>
	
  
</div>
	<a type="button" href="/2014/12/28/sample_algorithm/#more" class="btn btn-default more">阅读此文</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2014-04-03 </div>
			<div class="article-title"><a href="/2014/04/03/hadoop1/" >Hadoop2.2.0代码阅读-RPC部分</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <p>RPC部分的代码位于工程hadoop-common中，有三个主要的类。</p>
<p>1 org.apache.hadoop.ipc.Server</p>
<p>该类秉承了reactive programming的思想，结合了Java NIO，是一个高性能的服务器端实现，总的来说可以分为四部分。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">Listener:</span><br><span class="line"><span class="keyword">private</span> Listener listener = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">Listener</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 非阻塞同步I/O</span></span><br><span class="line">  <span class="keyword">private</span> ServerSocketChannel acceptChannel = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">private</span> Selector selector = <span class="keyword">null</span>;</span><br><span class="line">  <span class="comment">// 读进程</span></span><br><span class="line">  <span class="keyword">private</span> Reader[] readers = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Queue:</span><br><span class="line"><span class="keyword">private</span> BlockingQueue&lt;Call&gt; callQueue;</span><br><span class="line"></span><br><span class="line">Handler:</span><br><span class="line"><span class="keyword">private</span> Handler[] handlers = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">Handler</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">  <span class="annotation">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (running) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">//不断从队列中读取Call处理</span></span><br><span class="line">      <span class="keyword">final</span> Call call = callQueue.take();</span><br><span class="line">      <span class="comment">// call是一个抽象方法，选择合适的rpcInvoker，执行远程调用方法</span></span><br><span class="line">      value = call(...);</span><br><span class="line">      <span class="comment">//通过responder返回消息</span></span><br><span class="line">      responder.doRespond(call);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Responder:</span><br><span class="line"><span class="keyword">private</span> Responder responder = <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>
<p>另外网络层的读写逻辑和连接信息封装在public class Connection中。</p>
<p>2 org.apache.hadoop.ipc.Client</p>
<p>Client的实现很直观，就是一个基于ExecutorService的多线程客户端。</p>
<p>3 org.apache.hadoop.ipc.RPC</p>
<p>RPC类主要是对底层网络进行了封装，提供统一的编程接口，使用动态代理完成远程方法调用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RPC</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 封装方法调用的接口</span></span><br><span class="line">  <span class="comment">// 在WritableRpcEngine和ProtobufRpcEngine中有具体的实现</span></span><br><span class="line">  <span class="class"><span class="keyword">interface</span> <span class="title">RpcInvoker</span> </span>&#123;&#125;</span><br><span class="line">  <span class="comment">// 设置不同的序列化和反序列化引擎：WritableRpcEngine和ProtobufRpcEngine</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setProtocolEngine</span><span class="params">(...)</span> </span>&#123;&#125;</span><br><span class="line">  <span class="comment">// 构建客户端的代理对象</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">getProxy</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">  <span class="comment">// 构建RPC服务器的辅助类</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span> </span>&#123;&#125;</span><br><span class="line">  <span class="comment">// 对Server的再封装</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Server</span> <span class="keyword">extends</span> <span class="title">org</span>.<span class="title">apache</span>.<span class="title">hadoop</span>.<span class="title">ipc</span>.<span class="title">Server</span> </span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

	
	</div>
	
  
</div>
	<a type="button" href="/2014/04/03/hadoop1/#more" class="btn btn-default more">阅读此文</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2013-11-05 </div>
			<div class="article-title"><a href="/2013/11/05/notes_eyawtkasbwata/" >Reading notes: Everything You Always Wanted to Know About Synchronization but Were Afraid to Ask</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <p><a href="http://sigops.org/sosp/sosp13/papers/p33-david.pdf" target="_blank" rel="external">Everything You Always Wanted to Know About Synchronization but Were Afraid to Ask</a>，SOSP’13上的一篇文章，如果对concurrent感兴趣，那么推荐读一下。</p>
<p>扩展软件系统到多核很难很重要，关键在于synchronization。</p>
<blockquote>
<p>From the Greek “syn”, i.e., <em>with</em>, and “khronos”, i.e., <em>time</em>, synchronization denotes the act of coordinating the timeline of a set of processes. (供扯淡使用)</p>
</blockquote>
<p>也就是说，设计一个synchronization scheme，随着核数的增加，性能不下降。但是由于软件层面的同步与硬件层面的同步是相互独立的，所以很难提出普适性的设计，很难评估新的研究成果。总的来说同步的可扩展性主要在于硬件层面。</p>
<blockquote>
<p>Results of this study can be used to help predict the cost of a synchronization scheme, explain its behavior, design better schemes, as well as possibly improve future hardware design.</p>
</blockquote>
<p>本文有几个重要的结论：</p>
<ol style="list-style-type: decimal">
<li><p>crossing sockets significantly impacts synchronization, regardless of the layer, e.g., cache coherence, atomic operations, locks. Message passing can be viewed as a way to reduce sharing as it enforces partitioning of the shared data. However, it comes at the cost of lower performance (than locks) on a few cores or low contention.</p></li>
<li><p>non-uniformity affects scalability even within a single-socket many-core, i.e., synchronization on a Sun Niagara 2 scales better than on a Tilera TILE-Gx36.</p></li>
<li><p>spin locks should be preferred over more complex locks. Complex locks have a lower uncontested performance, a larger memory footprint, and only outperform spin locks under relatively high contention.</p></li>
<li><p>implementing multi-socket coherence using broadcast or an incomplete directory (as on the Opteron) is not favorable to synchronization.</p></li>
</ol>
<p>另外本文还贡献了一个跨平台的同步工具包<a href="http://lpd.epfl.ch/site/ssync" target="_blank" rel="external">SSYNC</a>。</p>

	
	</div>
	
  
</div>
	<a type="button" href="/2013/11/05/notes_eyawtkasbwata/#more" class="btn btn-default more">阅读此文</a>
</div>

		

		</div>

		<!-- pagination -->
		<div>
  		<center>
		<div class="pagination">
<ul class="pagination">
	 
		
          <li class="prev disabled"><a><i class="fa fa-arrow-circle-o-left"></i>上一页</a></li>
        

        <li><a href="/"><i class="fa fa-home"></i>Home</a></li>

		
		   <li class="next"> <a href="/page/2/" class="alignright next">下一页<i class="fa fa-arrow-circle-o-right"></i></a> </li>          
        
	
</ul>
</div>

  		</center>
		</div>

		
		
	</div> <!-- col-md-9 -->

	
		<div class="col-md-3">
	<div id="sidebar">
	
			<div class="form-group has-success has-feedback">
  <form action="//google.com/search" method="get" accept-charset="utf-8" >
    <input type="search" name="q" results="0" placeholder="搜索" class="form-control">
    <input type="hidden" name="q" value="site:shichaoyuan.github.io">	
  </form>
</div>

		
			
	<div class="widget">
		<h4>分类</h4>
		<ul class="tag_box inline list-unstyled">
		
			<li><a href="/categories/algorithm/">algorithm<span>2</span></a></li>
		
			<li><a href="/categories/concurrency/">concurrency<span>3</span></a></li>
		
			<li><a href="/categories/disruptor/">disruptor<span>5</span></a></li>
		
			<li><a href="/categories/engineering/">engineering<span>1</span></a></li>
		
			<li><a href="/categories/geohash/">geohash<span>1</span></a></li>
		
			<li><a href="/categories/hadoop/">hadoop<span>1</span></a></li>
		
			<li><a href="/categories/http-proxy/">http proxy<span>1</span></a></li>
		
			<li><a href="/categories/java/">java<span>2</span></a></li>
		
			<li><a href="/categories/log/">log<span>1</span></a></li>
		
			<li><a href="/categories/product/">product<span>1</span></a></li>
		
		</ul>
	</div>

		
			

		
			
<div class="widget">
  <h4>最新文章</h4>
  <ul class="entry list-unstyled">
    
      <li>
        <a href="/2015/06/15/link_prediction_problem/" ><i class="fa fa-file-o"></i>Link Prediction Problem...</a>
      </li>
    
      <li>
        <a href="/2015/05/26/geonear/" ><i class="fa fa-file-o"></i>关于附近的XXX...</a>
      </li>
    
      <li>
        <a href="/2015/04/09/privoxy/" ><i class="fa fa-file-o"></i>小工具Privoxy...</a>
      </li>
    
      <li>
        <a href="/2015/03/21/popular_data/" ><i class="fa fa-file-o"></i>思考热门发现Tab的内容配置...</a>
      </li>
    
      <li>
        <a href="/2015/02/16/gc_log_1/" ><i class="fa fa-file-o"></i>关于JAVA GC LOG —— 如何看...</a>
      </li>
    
  </ul>
</div>

		
			
<div class="widget">
	<h4>链接</h4>
	<ul class="blogroll list-unstyled">
	
		<li><i class="fa fa-github"></i><a href="http://www.github.com/shichaoyuan" title="My Github account." target="_blank"]);">My Github</a></li>
	
	</ul>
</div>


		
	</div> <!-- sidebar -->
</div> <!-- col-md-3 -->

	
	
</div> <!-- row-fluid -->
	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2015 Shichao Yuan
  
      with help from <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a>. Theme by <a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>.    
</p> </footer>
</div> <!-- container-narrow -->
  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>





<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


</body>
   </html>
